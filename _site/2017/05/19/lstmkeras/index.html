<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
    
  <!-- Enable responsiveness on mobile devices-->
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">-->
 

  <title>
    
      NLP Introduction to LSTM using Keras &middot; 
      pyVision
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/pyVision/public/css/poole.css">
  <link rel="stylesheet" href="/pyVision/public/css/syntax.css">
  <link rel="stylesheet" href="/pyVision/public/css/lanyon.css">
  <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">-->
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/pyVisionpublic/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/pyVisionpublic/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script type="text/x-mathjax-config">
   MathJax.Hub.Config({ 
                config: ["MMLorHTML.js"], 
                extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js"], 
                jax: ["input/TeX"], 
                tex2jax: { 
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ], 
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ], 
                    processEscapes: false 
                }, 
                TeX: { 
                    TagSide: "right", 
                    TagIndent: ".8em", 
                    MultLineWidth: "85%", 
                    equationNumbers: { 
                       autoNumber: "AMS", 
                    }, 
                    unicode: { 
                       fonts: "STIXGeneral,'Arial Unicode MS'" 
                    } 
                }, 
                showProcessingMessages: false 
            }); 
</script>
<!--<script src="/pyVision/javascripts/gitdata.js"></script>-->
	<script type="text/javascript">
    	$(function() {
        $("#display-projects").getRepos("pi19404"); //Add your github username.
    	});
	</script>
<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<link href='http://alexgorbatchev.com/pub/sh/2.1.364/styles/shCore.css' rel='stylesheet' type='text/css'/> 
<link href='http://alexgorbatchev.com/pub/sh/2.1.364/styles/shThemeDefault.css' rel='stylesheet' type='text/css'/> 
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shCore.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushCpp.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushCSharp.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushCss.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushJava.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushJScript.js' type='text/javascript' /> </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushPhp.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushPython.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushRuby.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushSql.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushVb.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushXml.js' type='text/javascript' > </script>
<script src='http://alexgorbatchev.com/pub/sh/2.1.364/scripts/shBrushPerl.js' type='text/javascript' > </script>
<script language='javascript'> 
SyntaxHighlighter.config.bloggerMode = false;
SyntaxHighlighter.all();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-38535188-2', 'auto');
  ga('send', 'pageview');

</script>
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">





  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/pyVision/">Home </a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/pyVision//about/">About</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
      
    

    <!-- <a class="sidebar-nav-item" href="http://www.github.com/pi19404/pyVision/zipball/master">Download</a>
    <a class="sidebar-nav-item" href="http://www.github.com/pi19404/pyVision">GitHub project</a> -->
    <a class="sidebar-nav-item" ><g:plusone size="medium">Categories</g:plusone> </a>
    <div>
      <ul>
        
        
        <li><a href="/pyVision//category/Linux/index.html">Linux</a></li>
        
        
        <li><a href="/pyVision//category/Signal+Processing/index.html">Signal Processing</a></li>
        
        
        <li><a href="/pyVision//category/Raspberry+PI/index.html">Raspberry PI</a></li>
        
        
        <li><a href="/pyVision//category/Software/index.html">Software</a></li>
        
        
        <li><a href="/pyVision//category/Embedded+Firmware/index.html">Embedded Firmware</a></li>
        
        
        <li><a href="/pyVision//category/Software+Installation/index.html">Software Installation</a></li>
        
        
        <li><a href="/pyVision//category/Software+installation/index.html">Software installation</a></li>
        
        </ul>
    
    </div>
<a class="sidebar-nav-item" >
<div class='g-person' data-href='https://plus.google.com/115840780257908006648' data-layout='landscape' data-rel='author' data-showcoverphoto='false' data-showtagline='false' data-theme='dark' data-width='100'></a>
</div>

<div class='widget-content'>
<script type="text/javascript" src="http://jj.revolvermaps.com/2/1.js?i=9bj6dpaloim&amp;s=220&amp;m=7&amp;v=true&amp;r=true&amp;b=ffffff&amp;n=false&amp;c=ff0000" async="async"></script>
</div>

<script type="text/javascript">
function cantload() {
img = document.getElementById("clustrMapsImg");
img.onerror = null;
img.src = "http://www2.clustrmaps.com/images/clustrmaps-back-soon.jpg";
document.getElementById("clustrMapsLink").href = "http://www2.clustrmaps.com";
}
img = document.getElementById("clustrMapsImg");
img.onerror = cantload;
</script>
<div class='widget-content'>
<div id="clustrmaps-widget"></div><script type="text/javascript">var _clustrmaps = {'url' : 'http://pi-virtualworld.blogspot.com', 'user' : 1165875, 'server' : '3', 'id' : 'clustrmaps-widget', 'version' : 1, 'date' : '2015-04-05', 'lang' : 'en', 'corners' : 'square' };(function (){ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'http://www3.clustrmaps.com/counter/map.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);})();</script><noscript><a href="http://www3.clustrmaps.com/user/ace11ca33"><img src="http://www3.clustrmaps.com/stats/maps-no_clusters/pi-virtualworld.blogspot.com-thumb.jpg" alt="Locations of visitors to this page" /></a></noscript>
</a>

<!-- Copyright (c)2009 Site Meter -->


</div>

<div class='widget-content'>
<script type="text/javascript" src="http://feedjit.com/serve/?vv=1022&amp;tft=3&amp;dd=0&amp;wid=f31e21a2d981f025&amp;pid=0&amp;proid=0&amp;bc=000000&amp;tc=F5F5F5&amp;brd1=454545&amp;lnk=C95050&amp;hc=FFFFFF&amp;hfc=5C5A5A&amp;btn=8A0214&amp;ww=200&amp;went=10"></script><noscript><a href="http://feedjit.com/">Feedjit Live Blog Stats</a></noscript>
</div>
 
<!-- Site Meter -->
<script type="text/javascript" src="http://s30.sitemeter.com/js/counter.js?site=s30pi19404">
</script>
<noscript>
<a href="http://s30.sitemeter.com/stats.asp?site=s30pi19404" target="_top">
<img src="http://s30.sitemeter.com/meter.asp?site=s30pi19404" alt="Site Meter" border="0"/></a>
</noscript>   
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2022. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      
        <div class="container">
          <h1 class="header">
            <a href="/" title="Home">pyVision</a></br>
            <small>A Machine Learning and Signal Processing toolbox</small>
          </h1>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/pi19404/pyVision/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/pi19404/pyVision/tarball/master" id="download-tar-gz" class="button"><span>Download.tar.gz</span></a>
          <a href="https://github.com/pi19404/pyVision" id="view-on-github" class="button"><span>View on GitHub</span></a>
		
	   <hr>
          </section>
    
	</br>	</br>
      <div class="content">
        <article class="post">
  <h1 class="post-title">NLP Introduction to LSTM using Keras</h1>
  <span class="post-date">19 May 2017</span>
  <h1 id="long-short-term-memory-network"><strong>Long Short-Term Memory Network</strong></h1>

<p>The Long Short-Term Memory network, or LSTM network, is a recurrent neural network.</p>

<p>RNN are networks with loops in them, allowing information to persist.Long Short Term Memory networks – usually just called “LSTMs” – are a special kind of RNN, capable of learning long-term dependencies</p>

<p>LSTMs are explicitly designed to avoid the long-term dependency problem. Remembering information for long periods of time is practically their default behavior, not something they struggle to lear</p>

<p>We can use LSTM for host of NLP classification problem.</p>

<h2 id="input-training-data"><strong>Input Training data</strong></h2>

<p>The input training data is of the form</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ u'text': u'11 dollar to rupee conversion', u'intent': u'"conversion"'}
</code></pre></div></div>

<h2 id="word-embedding"><strong>Word Embedding</strong></h2>

<p>The input to LSTM network is a sequence of tokens of the sentense and the output is associated class lable.
The LSTM network will model how various words belonging to a class occur in a statement/document.</p>

<p>We will be using spaCy NLP package.The built in word embedding function  provides a word vector of length 300.</p>

<p>For details about using spaCy and computing word vectors refer to the article http://34.194.184.172/emotix/index.php/2017/05/13/nlp-spacy-word-and-document-vectors/</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    def word2vec(self,tokens):
        output=[]
        for d in tokens:
            doc = self.nlp1(d['text'])
            t=[]
						l=[]
            for token in doc:
				  t.append(token.vector)								
			      l.append(token.lemma)
			d['tokens']=l
            d['features']=t;
            output.append(d)
        return output
</code></pre></div></div>

<p>Below is the code on how to call the above function</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vectors=nlp.word2vec(data)
print("number of training samples are", len(vectors))
print("dimension each token of training data ", len(vectors[0]['features'][0]))
</code></pre></div></div>

<p>The above function accepts the training data.For each sentence in the training data the function computes the document vector for each token and stores the list of features in the <code class="language-plaintext highlighter-rouge">features</code> tag of the output <code class="language-plaintext highlighter-rouge">json</code> data.</p>

<h2 id="pre-processing--the-sequential-data"><strong>Pre-Processing  the sequential data</strong></h2>

<p>Since we will be analyzing short sentences and not long paragraphs of text we will choose the maximum number of tokens in the sentence to be 40</p>

<p>If the tokens in a sentence are less than 40 we will be zero padding or trimming it so that all sequence are of the same length.This step pre-processes the sequential data so that training data consists of vectors of the same dimension.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    def pad_vec_sequences(self,sequences, maxlen=40):
        new_sequences = []
        for sequence in sequences:
            orig_len, vec_len = np.shape(sequence)

            if orig_len &lt; maxlen:
                new = np.zeros((maxlen, vec_len))
                new[maxlen - orig_len:, :] = sequence
            else:
                new = sequence[orig_len - maxlen:, :]
            new_sequences.append(new)

        return np.array(new_sequences)
</code></pre></div></div>

<p>The above function is used as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maxlen=40
Xtrain=[]
labels=[]
for d in vectors:
   Xtrain.append(d['features'])
   labels.append(d['intent'])
Xtrain = self.pad_vec_sequences(Xtrain, maxlen)						
</code></pre></div></div>

<p>The above function pads or truncates the input training data so that each sample of training data is of size <code class="language-plaintext highlighter-rouge">(maxlen,dimension)</code>
Thus inputs to the neural network are of fixed dimension vector of size (40,300) representing the sentence/document being analyzed.</p>

<p>We will prepare the training data in a form suitable to be used with keras</p>

<p>First we will process the output labels so that textual categories are covnverted to one hot encoded vector form</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from sklearn import preprocessing
from keras.utils import np_utils, generic_utils
				
self.label_encoder = preprocessing.LabelEncoder()
#converts text categories to integers
self.label_encoder.fit(labels)
y=self.label_encoder.transform(labels)
        
#converts integers to one hot encoded vectors
y=np_utils.to_categorical(y)
</code></pre></div></div>

<p>Our training data consists of 3 unique classes so the output vectors are encoded as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[1  0  0]
[0  1  0]
[0  0  1]

</code></pre></div></div>

<h2 id="training-and-cross-validation-data-split"><strong>Training and Cross Validation Data Split</strong></h2>

<p>No we will split our training data into training and cross validation data</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from sklearn.model_selection import train_test_split
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size = 0.70, random_state = 42)
</code></pre></div></div>

<p>This splits the training data such that 70% data is used for cross validation and 30% data is training data.</p>

<p>If the input training data X has 282 samples then <code class="language-plaintext highlighter-rouge">X_train</code> will have 84 and <code class="language-plaintext highlighter-rouge">X_test</code> will have 198 samples.</p>

<p><strong>Keras Pre Processing</strong></p>

<p>The training data required for keras is of the form <code class="language-plaintext highlighter-rouge">[samples, time steps, features]</code></p>

<p>In our case time steps is length of sequential data being analyed ie maximum number of words being analyzed in the sequence.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> X_train = numpy.reshape(X_train, (X_train.shape[0],X_train.shape[1],X_train.shape[2]))
</code></pre></div></div>

<p><strong>Keras Configuration</strong></p>

<p>Keras is a high-level neural networks API, written in Python and capable of running on top of either TensorFlow or Theano</p>

<p>We will be using tensorflow as backend to Keras</p>

<p>The core data structure of Keras is a model, a way to organize layers. The simplest type of model is the Sequential model, a linear stack of layers</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model = Sequential()
</code></pre></div></div>

<p>Stacking layers is as easy as <code class="language-plaintext highlighter-rouge">.add():</code></p>

<p>In the present example we want to configure Keras to use LSTM networks.Hence first layer we want to stack is LSTM</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> model.add(LSTM(32, input_shape=(X_train.shape[1], X_train.shape[2])))
</code></pre></div></div>

<p>The LSTM network will accepts input vectors of shape <code class="language-plaintext highlighter-rouge">(40,300)</code></p>

<p>The output of the LSTM network is class lable.Hence number of outputs of the last layer is equal to the number of unique classes.In the present example the number of output classes are 3.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model.add(Dense(nclasses, activation='softmax'))
</code></pre></div></div>

<p>We are specyfying that we will be using softmax activation function for the output layers</p>

<p>And then we can choose the how we want to model the hidden layers between the input and output layers</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
        model = Sequential()
        model.add(LSTM(32, input_shape=(X_train.shape[1], X_train.shape[2])))
        model.add(Dense(20))
        model.add(Dense(nclasses, activation='softmax'))
</code></pre></div></div>

<p>Once the layers of model are added we configure the parameters for the learning process</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
print(model.summary())
</code></pre></div></div>

<p>We choose <code class="language-plaintext highlighter-rouge">categorical_crossentropy</code> as loss function when we want to perform categorical classification task.We choose the optimizer as <code class="language-plaintext highlighter-rouge">adam optimizer</code> which is a slightly enhanced version of the stochastic gradient descent.For any categorical classification problem the <code class="language-plaintext highlighter-rouge">metrics</code> parameter is set to <code class="language-plaintext highlighter-rouge">accuracy</code></p>

<p><strong>Training the model</strong></p>

<p>To train the model</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> model.fit(X_train,y_train,epochs=10, batch_size=1, verbose=2)
</code></pre></div></div>

<p>we can choose the number of epochs and batch size so that training data can be iterated over in batches.</p>

<p><strong>Evaluating the model</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>loss_and_metrics = model.evaluate(x_test, y_test, batch_size=128)
print loss_and_metrics
model.save('my_model.h5')
</code></pre></div></div>

<p><strong>Batch Size</strong></p>

<p>The Keras implementation of LSTMs resets the state of the network after each batch.</p>

<p>This suggests that if we had a batch size large enough to hold all input patterns and if all the input patterns were ordered sequentially, that the LSTM could use the context of the sequence within the batch to better learn the sequence.</p>

<p>Keras shuffles the training dataset before each training epoch. To ensure the training data patterns remain sequential, we can disable this shuffling.</p>

<p><strong>References</strong></p>

<ul>
  <li>https://keras.io/getting-started/sequential-model-guide/</li>
  <li>https://keras.io/</li>
</ul>

</article>
<div id="page-navigation"> 
        <div class="clear">&nbsp;</div> 
        <div class="left"> 
         
                <a href="/pyVision//2017/05/19/corenlp1/" title="Previous Post: 
NLP Basics of using Stanford corenlp server">&laquo; NLP Basics of using Stanford corenlp server</a> 
         
        </div> 

        <div class="right"> 
         
                <a href="/pyVision//2017/05/24/javaaes/" title="next Post: 
Java AES encryption and decryption">Java AES encryption and decryption &raquo; </a> 
         
        </div> 
        <div class="clear">&nbsp;</div> 
</div> 
<div id="disqus_thread"></div>
		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			var disqus_shortname = 'pi19404'; // required: replace example with your forum shortname
    			var disqus_identifier = '/2017/05/19/lstmkeras/';
    			var disqus_url = 'http://pyvision.github.com/2017/05/19/lstmkeras/';       
 
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>





      </div>
    </div>

      
       <footer>
          pyVision is maintained by <a href="https://github.com/pi19404">pi19404</a><br>
        </footer>
    
    </div>
 <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = true;
        }, false);
      })(document);
    </script>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pyvision'; // required: replace example with your forum shortname
    var disqus_identifier = '/2017/05/19/lstmkeras/';
    var disqus_url = 'http://pyvision.github.com/2017/05/19/lstmkeras/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

  </body>
</html>
